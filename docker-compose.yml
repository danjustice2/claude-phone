version: '3.8'

# CRITICAL: All containers must use network_mode: host
# Docker bridge networking causes FreeSWITCH to advertise internal IPs
# in SDP, making RTP unreachable from external callers.

services:
  asterisk:
    build: ./asterisk
    container_name: asterisk
    restart: unless-stopped
    network_mode: host
    environment:
      - EXTERNAL_IP=${EXTERNAL_IP}
      - ASTERISK_SIP_PORT=${ASTERISK_SIP_PORT:-5060}
      - USER_EXT_PASSWORD=${USER_EXT_PASSWORD:-changeme}
    volumes:
      # Share device config so Asterisk auto-generates matching extensions
      - ./voice-app/config:/app/config:ro
    # Ports (for reference - host mode doesn't need port mapping):
    # - 5060: SIP UDP/TCP (Asterisk PBX)

  drachtio:
    image: drachtio/drachtio-server:latest
    container_name: drachtio
    restart: unless-stopped
    network_mode: host
    command: >
      drachtio
      --contact "sip:*:${DRACHTIO_SIP_PORT:-5070};transport=tcp,udp"
      --external-ip ${EXTERNAL_IP}
      --secret ${DRACHTIO_SECRET:-cymru}
      --port 9022
      --loglevel info
    depends_on:
      - asterisk
    # Ports (for reference - host mode doesn't need port mapping):
    # - 5070: SIP UDP/TCP (drachtio, avoids conflict with Asterisk on 5060)
    # - 9022: Admin/App Port

  freeswitch:
    image: drachtio/drachtio-freeswitch-mrf:latest
    container_name: freeswitch
    restart: unless-stopped
    network_mode: host
    command: >
      freeswitch
      --sip-port 5080
      --rtp-range-start 30000
      --rtp-range-end 30100
      --ext-rtp-ip ${EXTERNAL_IP}
      --ext-sip-ip ${EXTERNAL_IP}
      --advertise-external-ip
    environment:
      # CRITICAL: Set this to your server's LAN IP
      # This IP goes into SDP packets so Asterisk knows where to send audio
      # Note: drachtio-freeswitch-mrf only accepts CLI flags, not env vars
      - EXTERNAL_IP=${EXTERNAL_IP}
    depends_on:
      - asterisk
    # Ports (for reference):
    # - 8021: ESL (Event Socket Library)
    # - 5080: Internal SIP
    # - 30000-30100: RTP Audio

  voice-app:
    build: ./voice-app
    container_name: voice-app
    restart: unless-stopped
    network_mode: host
    env_file:
      - .env
    volumes:
      # Audio files directory for TTS playback
      - ./voice-app/audio:/app/audio
      # Device configurations
      - ./voice-app/config:/app/config
    depends_on:
      - drachtio
      - freeswitch
      - asterisk
    # Ports (for reference):
    # - 3000: HTTP API
    # - 3001: WebSocket for audio streaming
